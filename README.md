# Custom Automatic Weather Station
The aim of the C-AWS project was to develop from scratch a capable automatic weather station (AWS) system using non-professional sensors and electronics. This repository contains the core software system, designed to run on a Raspberry Pi. See [C-AWS Server](https://github.com/henryshunt/c-aws-server) for a website to view the data generated by this system, and [C-AWS Monitor](https://github.com/henryshunt/c-aws-monitor) for a Windows system tray program to view the latest live data.

This software is split into a data subsystem, which logs sensor data and generates statistics, and a support subsystem, which provides all other functionality including data uploading. `main.py` is the entry point, which performs checks before starting the subsystems as background processes. The rest of the code comprises a set of routines to support the subsystems, as well as a set of classes that abstract each sensor behind a common interface. Included is a routine that C-AWS Server can use to retrieve local system parameters such as startup time and remaining space.

Supported sensors: MCP9808 (temperature), DS18B20 (temperature), HTU21D (humidity), Inspeed Classic Anemometer (wind speed), Inspeed E-Vane II (wind direction) via MCP3008 ADC, Instromet Mini Sun Board with binary output (sunshine duration), Rainwise Rainew 111 (rainfall), BMP280 (pressure), Raspberry Pi Camera Module (camera).

This software was designed to work with a combination of hardware that produces a fully field-ready AWS unit:
- A Raspberry Pi with any or all of the above sensors connected, running Linux.
- Two push buttons for power controls (shutdown and restart)
- Two LEDs (one to indicate errors and another to indicate data being logged to the database)
- A real time clock should be connected
- Images from a camera should be saved to a USB drive which should auto-mount at startup

# Usage
- Run `SETUP.sh` to download and install the required dependencies
- Open the file `/etc/rc.local` (operations to run post-boot) and add the following before `exit 0`:
    - `cd /home/pi/c-aws` (change path to your C-AWS software directory)
    - `python3 main.py`
- Configure operation of the C-AWS software (see configuration section below)
- Restart the computer to run the software

# Configuration
`AWSInfo` Group:
- `TimeZone` (Required): Local time zone of the station. Must be a valid name in the "tz database"
- `Latitude` (Required): Latitude of the station in decimal degrees
- `Longitude` (Required): Longitude of the station in decimal degrees
- `Elevation` (Required): Elevation of the station above sea level in whole metres

`DataStores` Group:
- `DataDirectory` (Required): Absolute path to directory for writing data to
- `CameraDirectory`: Absolute path to directory for storing images taken by the camera

`DataEndpoints` Group:
- `RemoteSQLServer`: URL of the `upload.php` file to receive data on a remote server hosting [C-AWS Server](https://github.com/henryshunt/c-aws-server). Add `&pass=PASSWORD` to use a password
- `RemoteFTPServer`: URL of the FTP server that will be used to upload camera images
- `RemoteFTPUsername`: Username of the FTP server account to upload camera images to. Images will upload to the account's default directory
- `RemoteFTPPassword`: Password of the above FTP user

`Operations` Group:
- `EnvReportLogging` (Required): Should computer environment data (e.g. CPU and enclosure temperature) be logged?
- `CameraLogging` (Required): Should images be logged from a camera?
- `DayStatLogging` (Required): Should statistics (averages, minimums, maximums, totals) be logged for each date in the local time zone?
- `ReportUploading` (Required): Should the data reports be uploaded to the remote SQL server?
- `EnvReportUploading` (Required): Should the computer environment reports be uploaded to the remote SQL server?
- `CameraUploading` (Required): Should the camera images be uploaded to the remote FTP server?
- `DayStatUploading` (Required): Should the statistics be uploaded to the remote SQL database?

`Hardware` Group:
- `DataLEDPin`: Pin number of LED to indicate data being logged
- `ErrorLEDPin`: Pin number of LED to indicate any software errors
- `ShutdownPin`: Pin number of button to trigger computer shutdown
- `RestartPin`: Pin number of button to trigger computer restart

`Sensors` Group:
- `AirT` (Required): Is a sensor (MCP9808) connected to measure air temperature? This should be inside a radiation shield
- `ExpT` (Required): Is a sensor (DS18B20) connected to measure exposed temperature? This is not a conventional parameter but it provides an interesting indicator of the general weather conditions. This should not be - inside a radiation shield
- `ExpTAddress`: Address of the `ExpT` sensor
- `RelH` (Required): Is a sensor (HTU21D) connected to measure relative humidity?
- `WSpd` (Required): Is a sensor (Inspeed Classic Anemometer) connected to measure wind speed?
- `WSpdPin`: Pin number of the `WSpd` sensor
- `WDir` (Required): Is a sensor (Inspeed E-Vane II via MCP3008 ADC) connected to measure wind direction?
- `WDirChannel`: ADC channel number of the `WDir` sensor
- `WDirOffset`: A correction to add to measured wind directions to compensate for non-north sensor mounting
- `SunD` (Required): Is a sensor (Instromet Mini Sun Board with binary output) connected to measure sunshine duration?
- `SunDPin`: Pin number of the `SunD` sensor
- `Rain` (Required): Is a sensor (Rainwise Rainew 111) connected to measure rainfall?
- `RainPin`: Pin number of the `Rain` sensor
- `StaP` (Required): Is a sensor (BMP280) connected to measure barometric pressure at station elevation?
- `ST10` (Required): Is a sensor (DS18B20) connected to measure soil temperature at 10CM down?
- `ST10Address`: Address of the `ST10` sensor
- `ST30` (Required): Is a sensor (DS18B20) connected to measure soil temperature at 30CM down?
- `ST30Address`: Address of the `ST30` sensor
- `ST00` (Required): Is a sensor (DS18B20) connected to measure soil temperature at 1M down?
- `ST00Address`: Address of the `ST00` sensor
- `EncT` (Required): Is a sensor (DS18B20) connected to measure enclosure temperature? This should be inside the station's electronics box
- `EncTAddress`: Address of the `EncT` sensor

- `LogDewP`: Should dew point be calculated and logged? Requires `AirT` and `RelH` sensors
- `LogWGst`: Should wind gust be calculated and logged? Requires `WSpd` sensor
- `LogMSLP`: Should mean sea level pressure be calculated and logged? Requires `StaP`, `AirT` and `DewP` sensors

# Error Codes
Any errors that occur during operation are logged for debudding purposes to `log.txt` in the specified `DataDirectory`. Errors from the data subsystem illuminate the error LED.

When the data and error LEDs illuminate, turn off, come back on momentarily, then turn off again, a successful startup of the software has occurred. If the LEDs do not come back on or turn off for the second time then there was an error. These errors flash the error LED continuously a number of times to indicate the number of the error code. See below for a description of the codes.

|Flashes|Description|
|--|--|
|1|Not enough free space (< 100MB) on the `DataDirectory` drive (or error getting space)|
|2|Error creating the `DataDirectory`|
|3|Error creating a new main database file in the `DataDirectory`|
|4|Error creating a new upload database file in the `DataDirectory`|
|5|The specified `CameraDirectory` does not exist|
|6|The specified `CameraDirectory` does not have a USB drive mounted|
|7|Not enough free space (< 100MB) on the `CameraDirectory` drive (or error getting space)|
|8|Error launching the support subsystem|
|9|Error launching the data subsystem|

# Dependencies
- Python Daemon
- Advanced Python Scheduler
- Python TZ
- RPi.GPIO
- Adafruit Blinka
- Adafruit CircuitPython MCP9808
- Adafruit CircuitPython HTU21D
- Adafruit CircuitPython BMP280
- Adafruit CircuitPython MCP3XXX
- picamera
- GPIO Zero
- astral

# Version History
- 4.X.X
- 5.0.0 (Sep 2018)
- 5.0.1 (Sep 2018): Fixed a bug that prevented sunshine data from being read during the last second of the minute
- 5.0.2 (Dec 2018): Various minor tweaks to text on the data viewing pages. Removed yearly total rainfall and sunshine from climate page.
- 5.1.0 (Apr 2019): Rewritten data sub-system and various tweaks. Configuration now allows specification of which parameters to log. Fixed a bug that meant the first minute of the next day was not included in the previous day's averaged and totalled statistics. Removed monthly average wind gust from climate page. About page renamed to 'station'. Year graphs now end at the current day instead of yesterday.
- 5.1.1 (Apr 2019): Fixed a bug where the ExpT and EncT sensor addresses were the same
- 5.1.2 (Apr 2019): Fixed a bug preventing rainfall from being counted
- 5.2.0 (Jun 2019): Removed the access subsystem (replaced with separate codebade) and associated routines. Various small changes and fault tolerance improvements. Removed code to mount the camera drive.
- 5.2.1 (Jun 2019): Server interface now returns remaining camera drive space even if not logging from a camera
- 6.0.0 (Aug 2019): Rewritten sensor interfaces to be subclasses of `Sensor`. Upgraded AirT and RelH sensor interfaces to new sensors. Rewritten upload routines, now uses a database to store data to upload. Database routines simplified. Large amount of general refactoring and improvements.